---
title: "Different Approaches to Crash Data Visualization"
author: "Ashirwad Barnwal"
date: "8/30/2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
# Set global options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(htmltools.dir.version = FALSE)

# Load packages
library(conflicted)
library(here)
library(tidyverse)
conflict_prefer("filter", "dplyr")
library(rio)
library(lubridate)
library(USAboundaries)
library(sf)
library(leaflet)
library(leaflet.extras)
library(leaflet.minicharts)
library(mapview)
library(leafem)
library(leafsync)
library(widgetframe)
library(viridisLite)
library(knitr)

# Import crash data
fatal_crashes <- import(here("data", "ia-fatal-crashes-2015-19.rds"))
fatal_crashes_2019 <- filter(fatal_crashes, crash_year == 2019) %>%
  mutate(
    month = month(crash_date),
    season = if_else(month %in% c(5:10), "summer", "winter")
  )

# Iowa state & county boundaries
state_boundary <- st_geometry(us_states(resolution = "high", states = "IA"))
county_boundaries <- us_counties(resolution = "high", states = "IA") %>%
  select(name)
cong_district_boundaries <- us_congressional(
  resolution = "high", states = "IA"
) %>%
  select(district_id = cd115fp)

# Create a basemap
basemap <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = state_boundary, fill = FALSE, group = "Boundaries") %>%
  addHomeButton(ext = st_bbox(state_boundary), group = "Zoom to Iowa")
```

---
# What is Leaflet?

```{r leaflet-url}
include_url("https://leafletjs.com/", height = "475px")
```

---
# Leaflet for R

```{r leaflet-rstudio-url}
include_url("https://rstudio.github.io/leaflet/", height = "475px")
```

---
# Fatal crashes as circles

```{r circles, out.width = "100%"}
(
circles <- basemap %>%
  addCircles(data = fatal_crashes_2019)
)
```

---
# Fatal crashes as marker clusters

```{r marker-clusters, out.width = "100%"}
(
marker_clusters <- basemap  %>%
  addCircleMarkers(
    data = fatal_crashes_2019, clusterOptions = markerClusterOptions()
  )
)
```

---
# Fatal crashes as a heatmap

```{r heatmap, out.width = "100%"}
(
heatmap <- basemap %>%
  addHeatmap(data = fatal_crashes_2019, radius = 10)
)
```

---
# Fatal crashes as a choropleth map

```{r choropleth, out.width = "100%"}
# Find the number of fatal crashes by county
fatal_crashes_2019_by_county <- county_boundaries %>%
  mutate(n_crashes = lengths(st_contains(., fatal_crashes_2019)))

# Define color palette
color_pal <- colorBin(
  "viridis",
  domain = fatal_crashes_2019_by_county$n_crashes, 
  bins = c(0, 5, 10, 20, 30, Inf)
)

# Create the choropleth map
(
choropleth <- basemap %>%
  addPolygons(
    data = fatal_crashes_2019_by_county,
    color = "white",
    weight = 1.5,
    opacity = 0.75,
    fillColor = ~color_pal(n_crashes), 
    fillOpacity = 0.75,
    dashArray = "2"
  ) %>%
    addLegend(
      data = fatal_crashes_2019_by_county, 
      pal = color_pal,
      values = ~n_crashes
    )
)
```

---
# Fatal crashes as a minicharts map

```{r minicharts-single-var, out.width = "100%"}
# Find centroids of each county
county_centroids <- st_centroid(county_boundaries) %>%
  nest(data = geometry) %>%
  mutate(coords = map(data, ~ as_tibble(st_coordinates(.x)))) %>%
  unnest(coords) %>%
  select(name, lng = X, lat = Y)

# Compute fatal crash counts
fatal_crash_counts_by_county_2019 <- list(
  # overall counts
  overall = fatal_crashes_2019 %>%
    st_join(county_boundaries, st_within) %>%
    count(name) %>%
    rename(n_crashes = n) %>%
    st_drop_geometry(),
  # broken by season
  by_season = fatal_crashes_2019 %>%
    st_join(county_boundaries, st_within) %>%
    count(name, season) %>%
    rename(n_crashes = n) %>%
    st_drop_geometry() %>%
    pivot_wider(names_from = season, values_from = n_crashes)
)

# Create a leaflet map with minicharts
minicharts_data <- county_centroids %>%
  left_join(fatal_crash_counts_by_county_2019$overall, by = "name") %>%
  left_join(fatal_crash_counts_by_county_2019$by_season, by = "name") %>%
  replace_na(list(n_crashes = 0, summer = 0, winter = 0))

(
minicharts_single_var <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    minicharts_data$lng, 
    minicharts_data$lat,
    chartdata = minicharts_data$n_crashes,
    showLabels = TRUE
  )
)
```

---
# Map of fatal crashes with mini pie charts

```{r minicharts-pie, out.width = "100%"}
(
minicharts_pie <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    minicharts_data$lng, 
    minicharts_data$lat,
    chartdata = select(minicharts_data, summer, winter),
    type = "pie",
    colorPalette = c("#4fc13c", "#cccccc"),
    width = 30 * sqrt(minicharts_data$n_crashes) / 
      sqrt(max(minicharts_data$n_crashes)),
    transitionTime = 0
  )
)
```

---
# Map of fatal crashes with mini bar charts

```{r mini-barcharts, out.width = "100%"}
cong_district_centroids <- st_centroid(cong_district_boundaries) %>%
  nest(data = geometry) %>%
  mutate(coords = map(data, ~ as_tibble(st_coordinates(.x)))) %>%
  unnest(coords) %>%
  select(district_id, lng = X, lat = Y)

fatal_crash_counts_by_district_2019 <- fatal_crashes_2019 %>%
  mutate(quarter = quarter(crash_date)) %>%
  st_join(cong_district_boundaries, st_within) %>%
  count(district_id, quarter) %>%
  rename(n_crashes = n) %>%
  st_drop_geometry()

mini_barcharts_data <- cong_district_centroids %>%
  left_join(fatal_crash_counts_by_district_2019, by = "district_id") %>%
  mutate(quarter = str_c("Qtr", quarter, sep = "_")) %>%
  pivot_wider(names_from = quarter, values_from = n_crashes)

(
mini_barcharts <- basemap %>%
  addPolygons(
    data = cong_district_boundaries, 
    color = "lightblue", 
    weight = 2, 
    fill = FALSE
  ) %>%
  addMinicharts(
    mini_barcharts_data$lng, 
    mini_barcharts_data$lat,
    chartdata = select(mini_barcharts_data, Qtr_1:Qtr_4),
    colorPalette = viridis(4),
    width = 60, 
    height = 60
  )
)
```

---
# Data viz type: Animated mini circle charts

```{r mini-circles-animation}
# Create a data frame of 99 counties times 12 months
helper_data <- tibble(
  name = rep(unique(county_boundaries$name), each = 12), 
  crash_month = rep(
    str_c(2019, str_pad(1:12, 2, pad = 0), sep = "-"), times = 99
  )
)

# Compute 2019 fatal crashes by month for each county
fatal_crash_counts_by_county_2019[["by_month"]] <- fatal_crashes_2019 %>%
  mutate(crash_month = format_ISO8601(crash_date, precision = "ym")) %>%
  st_join(county_boundaries, st_within) %>%
  count(name, crash_month) %>%
  rename(n_crashes = n) %>%
  st_drop_geometry()

# Create data for generating mini circle charts animation
mini_circles_anim_data <- county_centroids %>%
  left_join(
    pluck(fatal_crash_counts_by_county_2019, "by_month"), by = "name"
  ) %>%
  right_join(helper_data, by = c("name", "crash_month")) %>%
  arrange(name, crash_month) %>%
  group_by(name) %>%
  fill(lng, lat, .direction = "updown") %>%
  ungroup() %>%
  replace_na(list(n_crashes = 0))

# Display the animation
mini_circles_animation <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    mini_circles_anim_data$lng, 
    mini_circles_anim_data$lat,
    chartdata = mini_circles_anim_data$n_crashes,
    time = mini_circles_anim_data$crash_month,
    showLabels = TRUE
  ) %>%
  syncWith("minicharts")
frameWidget(mini_circles_animation, height = 500)
```

---
# Data viz type: Animated mini pie charts

```{r mini-pies-animation}
# Compute 2019 fatal crashes by month and type of day for each county
fatal_crash_counts_by_county_2019[["by_month_daytype"]] <- fatal_crashes_2019 %>%
  mutate(
    crash_month = format_ISO8601(crash_date, precision = "ym"),
    day_type = if_else(is_weekend == FALSE, "weekday", "weekend")
  ) %>%
  st_join(county_boundaries, st_within) %>%
  count(name, crash_month, day_type) %>%
  rename(n_crashes = n) %>%
  st_drop_geometry() %>%
  pivot_wider(names_from = day_type, values_from = n_crashes)

# Create data for generating mini pie charts animation
mini_pies_anim_data <- county_centroids %>%
  left_join(
    pluck(fatal_crash_counts_by_county_2019, "by_month"), by = "name"
  ) %>%
  left_join(
    pluck(fatal_crash_counts_by_county_2019, "by_month_daytype"), 
    by = c("name", "crash_month")
  ) %>%
  right_join(helper_data, by = c("name", "crash_month")) %>%
  arrange(name, crash_month) %>%
  group_by(name) %>%
  fill(lng, lat, .direction = "updown") %>%
  ungroup() %>%
  replace_na(list(n_crashes = 0, weekday = 0, weekend = 0))

# Display the animation
mini_pies_animation <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    mini_pies_anim_data$lng, 
    mini_pies_anim_data$lat,
    chartdata = select(mini_pies_anim_data, weekday, weekend),
    time = mini_pies_anim_data$crash_month,
    type = "pie",
    colorPalette = plasma(6)[c(2, 5)],
    width = 30 * sqrt(mini_pies_anim_data$n_crashes) / 
      sqrt(max(mini_pies_anim_data$n_crashes)),
    transitionTime = 0
  ) %>%
  syncWith("minicharts")
frameWidget(mini_pies_animation, height = 500)
```

---
# Data viz type: Side-by-Side mini circle charts

.pull-left[

```{r mini-circles-anim-left}
frameWidget(mini_circles_animation, height = 500)
```

]

.pull-right[

```{r mini-circles-anim-right}
frameWidget(mini_circles_animation, height = 500)
```

]

---
# Synced heatmaps of summer (L) vs. winter (R) fatal crashes

```{r synced_heatmaps, out.width = "100%"}
heatmap_summer <- basemap %>%
  addHeatmap(data = filter(fatal_crashes_2019, season == "summer"), radius = 10)
heatmap_winter <- basemap %>%
  addHeatmap(data = filter(fatal_crashes_2019, season == "winter"), radius = 10)
  
(
synced_heatmaps <- sync(heatmap_summer, heatmap_winter)
)
```

---
# Desynced map of fatal crashes

```{r lattice-view, out.width = "100%"}
(
lattice_view <- latticeview(heatmap, heatmap)
)
```




