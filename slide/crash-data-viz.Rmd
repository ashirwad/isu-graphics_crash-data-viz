---
title: "Different Approaches to Crash Data Visualization"
author: "Ashirwad Barnwal"
date: "9/3/2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
# Set global options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(htmltools.dir.version = FALSE)

# Load packages
library(conflicted)
library(here)
library(tidyverse)
conflict_prefer("filter", "dplyr")
library(rio)
library(lubridate)

# Spatial analyses & visualization
library(USAboundaries)
library(sf)
library(leaflet)
library(leaflet.extras)
library(leaflet.extras2)
library(leaflet.minicharts)
library(mapview)
library(leafem)
library(leafsync)

library(widgetframe)
library(viridisLite)
library(knitr)
library(DT)
library(default)
default(frameWidget) <- list(height = 500)
library(fontawesome)
library(emo)

# Import crash data
fatal_crashes <- import(here("data", "ia-fatal-crashes-2015-19.rds"))
fatal_crashes_2019 <- filter(fatal_crashes, crash_year == 2019) %>%
  mutate(
    month = month(crash_date),
    season = if_else(month %in% c(5:10), "summer", "winter")
  )

# Create a basemap
basemap <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = state_boundary, fill = FALSE, group = "Boundaries") %>%
  addHomeButton(ext = st_bbox(state_boundary), group = "Zoom to Iowa")
```

---
# Who am I?

~~No one cared who I was until I put on the mask.~~ `r emo::ji("wink")`

.pull-left[

Brief background:

- 3rd year PhD student in Civil Engineering (Transportation Data Analytics)
- 2nd year MS student in Statistics (concurrent degree)
- I took Stat 579 (Intro to R) with Dr. Hofmann in Fall 2018

Connect with me at:

- [`r fa(name = "linkedin")` @ashirwad1992](www.linkedin.com/in/ashirwad1992)
- [`r fa(name = "paper-plane")` ashirwad1992@gmail.com](mailto:ashirwad1992@gmail.com)
- [`r fa(name = "github")` @ashirwad](http://github.com/ashirwad)

]

.pull-right[

```{r profile-pic}
include_graphics("../img/covid-profile-pic.png")
```

Added mask to my photo using [Kapwing](https://www.kapwing.com/) `r emo::ji("laugh")`

]

---
# What's the goal of this presentation?

.pull-left[

Start here:

![classic+animation+choices](https://media0.giphy.com/media/Jyx7xUsUtHSjm/giphy.gif)  
<div style='font-size:50%'>(Available at [http://gph.is/1bbZpie](http://gph.is/1bbZpie), Sep 02, 2020)</div>  

]

.pull-right[

End here:

![which+one+choices](https://media2.giphy.com/media/Uni2jYCihB3fG/giphy.gif)  
<div style='font-size:50%'>(Available at [http://gph.is/2alF2tv](http://gph.is/2alF2tv), Sep 02, 2020)</div>  

]

---
class: center, inverse, middle

Enough of comic...  
Let's get started with some serious data visualization!

![serious](https://media4.giphy.com/media/Fr51PdEf2NxOE/giphy.gif)  
<div style='font-size:50%'>(Available at [http://gph.is/1qKXewI](http://gph.is/1qKXewI), Sep 02, 2020)</div>  

---
# What is Leaflet?

```{r leaflet-url}
include_url("https://leafletjs.com/", height = "475px")
```

---
# Leaflet for R

```{r leaflet-rstudio-url}
include_url("https://rstudio.github.io/leaflet/", height = "475px")
```

---
# What open data am I using?

```{r iowadot-opendata-url}
include_url("https://public-iowadot.opendata.arcgis.com/", height = "475px")
```

---
# Some notes about the data processing

- **Step 1**: Downloaded [crash data](https://data.iowadot.gov/datasets/crash-data-1) from the open data portal. The data has records of all crashes that occurred within Iowa over the last 10 years.
- **Step 2**: Processed data and extracted 5 years (2015--2019) worth of fatal crashes 

Here's a glimpse of the extracted data set:

```{r fatal-crashes-table}
fatal_crashes_table <- datatable(
  head(fatal_crashes), options = list(pageLength = 3)
)
frameWidget(fatal_crashes_table)
```

---
# Map with circles
**Note**: Unless stated otherwise, this and subsequent data visualizations uses 2019 fatal crash data to improve leaflet rendering performance.

```{r circles}
circles <- basemap %>%
  addCircles(data = fatal_crashes_2019, color = viridis(1))
frameWidget(circles, height = 450)
```

---
# Map with circles and a minimap

```{r circles-minimap}
circles_minimap <- circles %>%
  addMiniMap(toggleDisplay = TRUE, tiles = providers$CartoDB.Positron)
frameWidget(circles_minimap)
```

---
# Map with marker clusters

```{r marker-clusters}
marker_clusters <- basemap  %>%
  addCircleMarkers(
    data = fatal_crashes_2019, clusterOptions = markerClusterOptions()
  )
frameWidget(marker_clusters)
```

---
# Map with a heatmap layer

```{r heatmap}
heatmap <- basemap %>%
  addHeatmap(data = fatal_crashes_2019, radius = 10)
frameWidget(heatmap)
```

---
# Map with a hexbin-based heatmap layer

```{r hexbin-heatmap}
hexbin_heatmap <- basemap %>%
  addHexbin(
    data = fatal_crashes_2019, 
    options = hexbinOptions(colorRange = viridis(3), radiusRange = c(10, 20))
  )
frameWidget(hexbin_heatmap)
```

---
# Map with layers control 

```{r overlay-layers-control}
overlay_layers_control <- basemap %>%
  addHeatmap(data = fatal_crashes_2019, radius = 10, group = "Heatmap") %>%
  addCircles(
    data = fatal_crashes_2019, color = viridis(1), group = "Circles"
  ) %>%
  addCircleMarkers(
    data = fatal_crashes_2019, 
    clusterOptions = markerClusterOptions(), 
    group = "Marker Clusters"
  ) %>%
  addMiniMap(toggleDisplay = TRUE, tiles = providers$CartoDB.Positron) %>%
  addLayersControl(
    overlayGroups = c("Circles", "Marker Clusters", "Heatmap"),
    options = layersControlOptions(collapsed = FALSE)
  )
frameWidget(overlay_layers_control)
```

---
# Map with base and overlay layers control

```{r both-layers-control}
both_layers_control <- basemap %>%
  addProviderTiles(providers$CartoDB.Positron, group = "CartoDB.Positron") %>%
  addProviderTiles(
    providers$CartoDB.DarkMatter, group = "CartoDB.DarkMatter"
  ) %>%
  addProviderTiles(providers$OpenStreetMap, group = "OpenStreetMap") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri.WorldImagery") %>%
  addHeatmap(data = fatal_crashes_2019, radius = 10, group = "Heatmap") %>%
  addCircles(
    data = fatal_crashes_2019, color = viridis(1), group = "Circles"
  ) %>%
  addCircleMarkers(
    data = fatal_crashes_2019, 
    clusterOptions = markerClusterOptions(), 
    group = "Marker Clusters"
  ) %>%
  addMiniMap(toggleDisplay = TRUE, tiles = providers$CartoDB.Positron) %>%
  addLayersControl(
    baseGroups = c(
      "CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", 
      "Esri.WorldImagery"
    ),
    overlayGroups = c("Circles", "Marker Clusters", "Heatmap"),
    options = layersControlOptions(collapsed = FALSE)
  )
frameWidget(both_layers_control)
```

---
# Map with synced heatmap layers
Summer (L) vs. Winter (R) fatal crashes:

```{r synced-heatmaps}
heatmap_summer <- basemap %>%
  addHeatmap(data = filter(fatal_crashes_2019, season == "summer"), radius = 10)
heatmap_winter <- basemap %>%
  addHeatmap(data = filter(fatal_crashes_2019, season == "winter"), radius = 10)

(
synced_heatmaps <- sync(heatmap_summer, heatmap_winter)
)
```

---
# Map with desynced heatmap layers
Same heatmap on both left & right panes:

```{r lattice-view}
(
lattice_view <- latticeview(heatmap, heatmap)
)
```

---
# Map with a choropleth layer

```{r choropleth}
# Define color palette
color_pal <- colorBin(
  "viridis",
  domain = fatal_crashes_2019_by_county$n_crashes, 
  bins = c(0, 5, 10, 20, 30, Inf)
)

# Create the choropleth map
choropleth <- basemap %>%
  addPolygons(
    data = fatal_crashes_2019_by_county,
    color = "white",
    weight = 1.5,
    opacity = 0.75,
    fillColor = ~color_pal(n_crashes), 
    fillOpacity = 0.75,
    dashArray = "2"
  ) %>%
    addLegend(
      data = fatal_crashes_2019_by_county, 
      pal = color_pal,
      values = ~n_crashes
    )
frameWidget(choropleth)
```

---
# Map with mini circle charts

```{r minicharts-single-var}
# Create a leaflet map with minicharts
minicharts_single_var <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    minicharts_data$lng, 
    minicharts_data$lat,
    chartdata = minicharts_data$n_crashes,
    showLabels = TRUE
  )
frameWidget(minicharts_single_var)
```

---
# Map with mini pie charts

```{r minicharts-pie}
minicharts_pie <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    minicharts_data$lng, 
    minicharts_data$lat,
    chartdata = select(minicharts_data, summer, winter),
    type = "pie",
    colorPalette = c("#4fc13c", "#cccccc"),
    width = 30 * sqrt(minicharts_data$n_crashes) / 
      sqrt(max(minicharts_data$n_crashes)),
    transitionTime = 0
  )
frameWidget(minicharts_pie)
```

---
# Map with mini bar charts

```{r mini-barcharts}
mini_barcharts <- basemap %>%
  addPolygons(
    data = cong_district_boundaries, 
    color = "lightblue", 
    weight = 2, 
    fill = FALSE
  ) %>%
  addMinicharts(
    mini_barcharts_data$lng, 
    mini_barcharts_data$lat,
    chartdata = select(mini_barcharts_data, Qtr_1:Qtr_4),
    colorPalette = viridis(4),
    width = 60, 
    height = 60
  )
frameWidget(mini_barcharts)
```

---
# Animated map with mini circle charts

```{r mini-circles-animation}
# Display the animation
mini_circles_animation <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    mini_circles_anim_data$lng, 
    mini_circles_anim_data$lat,
    chartdata = mini_circles_anim_data$n_crashes,
    time = mini_circles_anim_data$crash_month,
    showLabels = TRUE
  ) %>%
  syncWith("minicharts")
frameWidget(mini_circles_animation)
```

---
# Animated map with mini pie charts
Weekday vs. Weekend fatal crashes

```{r mini-pies-animation}
# Display the animation
mini_pies_animation <- basemap %>%
  addPolygons(data = county_boundaries, weight = 2, fill = FALSE) %>%
  addMinicharts(
    mini_pies_anim_data$lng, 
    mini_pies_anim_data$lat,
    chartdata = select(mini_pies_anim_data, weekday, weekend),
    time = mini_pies_anim_data$crash_month,
    type = "pie",
    colorPalette = plasma(6)[c(2, 5)],
    width = 30 * sqrt(mini_pies_anim_data$n_crashes) / 
      sqrt(max(mini_pies_anim_data$n_crashes)),
    transitionTime = 0
  ) %>%
  syncWith("minicharts")
frameWidget(mini_pies_animation, height = 450)
```

---
# Animated map with side-by-side mini circle charts
Same mini circle charts on both panes:

.pull-left[

```{r mini-circles-anim-left}
frameWidget(mini_circles_animation, height = 400)
```

]

.pull-right[

```{r mini-circles-anim-right}
frameWidget(mini_circles_animation, height = 400)
```

]

---
# Animated map with side-by-side circle & pie minicharts

.pull-left[

```{r mini-circles-anim-left2}
frameWidget(mini_circles_animation, height = 450)
```

]

.pull-right[

```{r mini-pies-anim-right}
frameWidget(mini_pies_animation, height = 450)
```

]

